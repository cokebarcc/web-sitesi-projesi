import{w as M,q as Y,c as j,d as G,g as C,r as _,s as q,u as x,a as V,b as z,e as P,f as Z,h as J}from"./index-1yWk5K6C.js";async function v(o,n,i,t,s){try{console.log("ğŸš€ [STORAGE] Dosya yÃ¼kleme baÅŸlÄ±yor...");const a=Date.now(),r=o.name.replace(/[^a-zA-Z0-9.-]/g,"_"),u=`detailed-schedules/${n}/${t}/${i}/${a}_${r}`;console.log("ğŸ“ [STORAGE] Yol:",u);const $=_(q,u),H=await x($,o);console.log("âœ… [STORAGE] Dosya yÃ¼klendi");const S=await V($);console.log("âœ… [STORAGE] URL alÄ±ndÄ±:",S),console.log("ğŸ“Š [STORAGE] Excel parse ediliyor...");const h=await o.arrayBuffer(),p=z(new Uint8Array(h),{type:"array"});let y=0;p.SheetNames.forEach(l=>{const b=p.Sheets[l],k=P.sheet_to_json(b,{raw:!0});y+=k.filter(d=>{const g=d[(B=>{const w=A=>String(A||"").toLocaleLowerCase("tr-TR").trim().replace(/ÅŸ/g,"s").replace(/Ä±/g,"i").replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/Ã¶/g,"o").replace(/Ã§/g,"c").replace(/\s+/g,"");return Object.keys(d).find(A=>B.some(f=>w(A)===w(f)))})(["Hekim Ad Soyad","Hekim","Ad Soyad"])||""];return g&&String(g).trim()!==""}).length}),console.log("âœ… [STORAGE] Parse tamamlandÄ±:",y,"kayÄ±t");const F={hospital:n,month:i,year:t,fileName:o.name,fileUrl:S,recordCount:y,uploadedAt:a,uploadedBy:s};return await Z(j(G,"detailedScheduleFiles"),F),console.log("âœ… [STORAGE] Metadata Firestore'a kaydedildi"),console.log("ğŸ‰ [STORAGE] Ä°ÅŸlem BAÅARILI:",y,"kayÄ±t"),{success:!0,recordCount:y}}catch(a){return console.error("âŒ [STORAGE] HATA:",a),console.error("âŒ [STORAGE] Mesaj:",a.message),console.error("âŒ [STORAGE] Kod:",a.code),{success:!1,error:a.message||String(a)}}}async function Q(o,n,i){try{let t;const s=[];if(o&&s.push(M("hospital","==",o)),n&&s.push(M("month","==",n)),i&&s.push(M("year","==",i)),s.length>0){const r=Y(j(G,"detailedScheduleFiles"),...s);t=await C(r)}else t=await C(j(G,"detailedScheduleFiles"));const a=[];return t.forEach(r=>{a.push({id:r.id,...r.data()})}),a.sort((r,u)=>u.uploadedAt-r.uploadedAt)}catch(t){return console.error("âŒ Dosya listesi yÃ¼kleme hatasÄ±:",t),[]}}async function W(o,n,i,t){try{console.log(`ğŸ“‚ Dosya indiriliyor: ${n} ${i} ${t}`);const a=new URL(o).pathname.match(/\/o\/(.+)/);if(!a)throw console.error("âŒ URL parse hatasÄ±:",o),new Error(`Invalid file URL: ${o}`);const r=decodeURIComponent(a[1]),u=_(q,r),H=await(await J(u)).arrayBuffer(),S=z(new Uint8Array(H),{type:"array",cellDates:!0,cellNF:!0}),h=[];return S.SheetNames.forEach(p=>{const y=S.Sheets[p];P.sheet_to_json(y,{raw:!0}).forEach((l,b)=>{const k=e=>String(e||"").toLocaleLowerCase("tr-TR").trim().replace(/ÅŸ/g,"s").replace(/Ä±/g,"i").replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/Ã¶/g,"o").replace(/Ã§/g,"c").replace(/\s+/g,""),d=e=>Object.keys(l).find(c=>e.some(D=>k(c)===k(D))),R=l[d(["Hekim Ad Soyad","Hekim","Ad Soyad"])||""];if(!R||String(R).trim()==="")return;const g=l[d(["Aksiyon Tarihi","Tarih","GÃ¼nÃ¼"])||""],B=l[d(["Klinik AdÄ±","Klinik","BranÅŸ","BÃ¶lÃ¼m"])||""],w=l[d(["Aksiyon","Ä°ÅŸlem"])||""],A=l[d(["Randevu Kapasitesi","Kapasite","Slot SayÄ±sÄ±"])||""],f=l[d(["Aksiyon BaÅŸlangÄ±Ã§ Saati","BaÅŸlangÄ±Ã§ Saati","Saat"])||""],T=l[d(["Aksiyon BitiÅŸ Saati","BitiÅŸ Saati"])||""];let L="Bilinmiyor";if(g){let e=null;if(g instanceof Date)e=new Date(g.getTime()),e.getHours()>=21&&e.setHours(e.getHours()+4),e.setHours(12,0,0,0);else if(typeof g=="string"){const c=g.trim().split(/[./-]/);if(c.length===3){const D=parseInt(c[0]),m=parseInt(c[1]);let O=parseInt(c[2]);O<100&&(O+=2e3),!isNaN(m)&&m>=1&&m<=12&&(e=new Date(O,m-1,D))}}else typeof g=="number"&&(e=new Date(Math.round((g-25569)*864e5)),e.setHours(12,0,0,0));if(e&&!isNaN(e.getTime())){const c=String(e.getDate()).padStart(2,"0"),D=String(e.getMonth()+1).padStart(2,"0"),m=e.getFullYear();L=`${c}.${D}.${m}`}}const N=e=>{if(!e)return 0;if(e instanceof Date)return e.getHours()*60+e.getMinutes();if(typeof e=="number")return Math.round(e*1440);const c=String(e).trim().split(":");return c.length>=2?parseInt(c[0])*60+parseInt(c[1]):0},U=N(f),I=N(T);let E=I-U;E<0&&(E+=1440);const K=e=>`${String(Math.floor(e/60)).padStart(2,"0")}:${String(e%60).padStart(2,"0")}`;h.push({id:`ds-${Date.now()}-${p}-${b}-${Math.random()}`,specialty:String(B||p||"Bilinmiyor").toUpperCase().trim(),doctorName:String(R).trim().toUpperCase(),hospital:n,startDate:L,startTime:f?typeof f=="string"?f:K(U):"",endDate:"",endTime:T?typeof T=="string"?T:K(I):"",action:String(w||"Belirsiz").trim(),slotCount:0,duration:E,capacity:parseFloat(String(A).replace(/\./g,"").replace(",","."))||0,month:i,year:t})})}),console.log(`âœ… ${h.length} kayÄ±t yÃ¼klendi`),h}catch(s){return console.error("âŒ Dosya okuma hatasÄ±:",s),[]}}async function ee(o,n,i){try{const t=await Q(o,n,i),s=[],a=[o&&`Hastane: ${o}`,n&&`Ay: ${n}`,i&&`YÄ±l: ${i}`].filter(Boolean).join(", ")||"TÃ¼mÃ¼";console.log(`ğŸ“¦ ${t.length} dosya yÃ¼klenecek... (${a})`);for(const r of t){const u=await W(r.fileUrl,r.hospital,r.month,r.year);s.push(...u)}return console.log(`âœ… Toplam ${s.length} kayÄ±t yÃ¼klendi`),s}catch(t){return console.error("âŒ TÃ¼m dosyalarÄ± yÃ¼kleme hatasÄ±:",t),[]}}export{Q as getDetailedScheduleFiles,ee as loadAllDetailedScheduleData,W as loadDetailedScheduleData,v as uploadDetailedScheduleFile};
